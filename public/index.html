<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>èŠå¤©å®¤</title>
<style>
  :root {
    --sunset-yellow: #FFD54F;
    --light-red: #FF8A80;
    --warm-orange: #FFB74D;
    --cool-teal: #4DB6AC;
    --light-purple: #BA68C8;
    --light-pink: #F48FB1;
  }
  body {
    margin: 0;
    font-family: sans-serif;
    background: linear-gradient(135deg, var(--sunset-yellow) 0%, var(--light-red) 20%, var(--warm-orange) 40%, var(--cool-teal) 60%, var(--light-purple) 80%, var(--light-pink) 100%);
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255,255,255,0.2);
    padding: 10px;
    color: #fff;
    font-weight: bold;
    backdrop-filter: blur(5px);
  }
  .top-center {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .top-center img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
  }
  .top-bar button {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #fff;
  }
  #log {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }
  .msg {
    max-width: 70%;
    padding: 8px 12px;
    margin: 5px 0;
    border-radius: 12px;
    color: #000;
    background: rgba(255,255,255,0.8);
    word-wrap: break-word;
  }
  .me {
    background: rgba(255,255,255,0.9);
    align-self: flex-end;
  }
  .other {
    background: rgba(255,255,255,0.6);
    align-self: flex-start;
  }
  .system {
    background: rgba(200,200,200,0.7);
    text-align: center;
    color: #000;
  }
  .input-area {
    display: flex;
    padding: 10px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(5px);
  }
  #msg {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 20px;
    outline: none;
  }
  #sendBtn, #emojiBtn {
    margin-left: 5px;
    padding: 8px 12px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    background: rgba(255,255,255,0.9);
  }
</style>
</head>
<body>

<!-- é¡¶éƒ¨æ  -->
<div class="top-bar">
  <button onclick="window.location.href='/'">ğŸ </button>
  <div class="top-center">
    <img id="partnerAvatar" src="https://via.placeholder.com/32?text=?" alt="å¯¹æ–¹å¤´åƒ">
    <span id="partnerName">æœªçŸ¥ç”¨æˆ·</span>
  </div>
  <button onclick="startCall()">ğŸ“</button>
</div>

<!-- æ¶ˆæ¯è®°å½• -->
<div id="log"></div>

<!-- è¾“å…¥æ¡† -->
<div class="input-area">
  <input id="msg" placeholder="è¾“å…¥æ¶ˆæ¯..." />
  <button id="emojiBtn" onclick="insertEmoji()">ğŸ˜Š</button>
  <button id="sendBtn" onclick="send()" disabled>å‘é€</button>
</div>

<script>
let username = prompt("è¯·è¾“å…¥ä½ çš„æ˜µç§°");
while(!username || username.trim() === "") {
  username = prompt("æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼Œè¯·è¾“å…¥ä½ çš„æ˜µç§°");
}

const partnerAvatar = document.getElementById("partnerAvatar");
const partnerName = document.getElementById("partnerName");
const logDiv = document.getElementById("log");
const socket = new WebSocket("wss://blackbox-chat.onrender.com");

let partnerInfo = { username: "æœªçŸ¥ç”¨æˆ·", avatar: "https://via.placeholder.com/32?text=?" };

// -------------------- èŠå¤©åŠŸèƒ½ --------------------
socket.onopen = () => {
  log("âœ… å·²è¿æ¥èŠå¤©å®¤", "system");
  document.getElementById("sendBtn").disabled = false;
  socket.send(JSON.stringify({ system: true, join: true, username, avatar: "" }));
};

socket.onmessage = async (e) => {
  try {
    const data = JSON.parse(e.data);

    // ç³»ç»Ÿæ¶ˆæ¯
    if(data.system) {
      log(data.msg, "system");
      if(data.join && data.username !== username) {
        partnerInfo.username = data.username;
        partnerInfo.avatar = data.avatar || partnerInfo.avatar;
        partnerName.textContent = partnerInfo.username;
        partnerAvatar.src = partnerInfo.avatar;
      }
    } 
    // WebRTCä¿¡ä»¤
    else if(data.type === 'offer' && !isCalling){
      window.incomingOffer = data.offer;
      partnerInfo.username = data.username;
      partnerName.textContent = partnerInfo.username;
      partnerAvatar.src = data.avatar || partnerAvatar.src;
      startCall(true); // è¢«å«
    } 
    else if(data.type === 'answer'){
      await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
    } 
    else if(data.type === 'ice' && data.candidate){
      if(peerConnection){
        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    } 
    // æ™®é€šèŠå¤©æ¶ˆæ¯
    else {
      const type = data.username === username ? "me" : "other";
      log(`${data.username}: ${data.msg}`, type);
      if(data.username !== username){
        partnerInfo.username = data.username;
        partnerName.textContent = partnerInfo.username;
        partnerAvatar.src = data.avatar || partnerAvatar.src;
      }
    }
  } catch {
    log(e.data, "other");
  }
};

socket.onerror = () => log("âŒ è¿æ¥å‡ºé”™", "system");

function send() {
  const msgInput = document.getElementById("msg");
  const msg = msgInput.value.trim();
  if (!msg) return;
  if(socket.readyState === WebSocket.OPEN){
    const data = { username, msg, avatar: "" };
    socket.send(JSON.stringify(data));
    msgInput.value = "";
  } else {
    log("âš ï¸ è¿æ¥å°šæœªå»ºç«‹", "system");
  }
}

function log(message, type="other"){
  const msgDiv = document.createElement("div");
  msgDiv.className = `msg ${type}`;
  msgDiv.textContent = message;
  logDiv.appendChild(msgDiv);
  logDiv.scrollTop = logDiv.scrollHeight;
}

function insertEmoji(){
  const msgInput = document.getElementById("msg");
  msgInput.value += "ğŸ˜Š";
  msgInput.focus();
}

// -------------------- WebRTCè¯­éŸ³é€šè¯åŠŸèƒ½ --------------------
let localStream;
let peerConnection;
let isCalling = false;
const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

function startCall(isIncoming=false){
  if(isCalling) return;
  isCalling = true;

  // åˆ›å»ºé€šè¯ç•Œé¢
  const callOverlay = document.createElement('div');
  callOverlay.id = 'callOverlay';
  Object.assign(callOverlay.style,{
    position:'fixed',top:0,left:0,width:'100%',height:'100%',
    background:'rgba(255,255,255,0.2)',backdropFilter:'blur(10px)',
    display:'flex',flexDirection:'column',justifyContent:'center',alignItems:'center',
    zIndex:9999
  });

  const status = document.createElement('div');
  status.id = 'callStatus';
  status.innerText = isIncoming ? `${partnerInfo.username} æ¥ç”µ` : 'æ­£åœ¨ç­‰å¾…å¯¹æ–¹æ¥å¬...';
  Object.assign(status.style,{marginBottom:'20px',color:'#fff',fontSize:'20px'});
  callOverlay.appendChild(status);

  const audio = document.createElement('audio');
  audio.src = 'https://actions.google.com/sounds/v1/alarms/bugle_tune.ogg';
  audio.loop = true;
  audio.autoplay = true;
  callOverlay.appendChild(audio);

  const hangupBtn = document.createElement('button');
  hangupBtn.innerText = 'ğŸ“æŒ‚æ–­';
  Object.assign(hangupBtn.style,{background:'red',color:'#fff',marginRight:'20px',padding:'10px 20px'});
  hangupBtn.onclick = () => endCall(true);

  const acceptBtn = document.createElement('button');
  acceptBtn.innerText = 'ğŸ“æ¥å¬';
  Object.assign(acceptBtn.style,{background:'green',color:'#fff',padding:'10px 20px'});
  acceptBtn.onclick = acceptCall;

  const btnContainer = document.createElement('div');
  btnContainer.style.display = 'flex';
  if(isIncoming) btnContainer.appendChild(acceptBtn);
  btnContainer.appendChild(hangupBtn);
  callOverlay.appendChild(btnContainer);

  document.body.appendChild(callOverlay);

  // è·å–éº¦å…‹é£
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    localStream = stream;
    peerConnection = new RTCPeerConnection(config);
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.ontrack = e => {
      let remoteAudio = document.getElementById('remoteAudio');
      if(!remoteAudio){
        remoteAudio = document.createElement('audio');
        remoteAudio.id = 'remoteAudio';
        remoteAudio.autoplay = true;
        document.body.appendChild(remoteAudio);
      }
      remoteAudio.srcObject = e.streams[0];
    };

    peerConnection.onicecandidate = e => {
      if(e.candidate) {
        socket.send(JSON.stringify({ type:'ice', candidate:e.candidate, to: partnerInfo.username }));
      }
    };

    if(!isIncoming){
      // ä¸»å«åˆ›å»ºoffer
      peerConnection.createOffer().then(offer => {
        peerConnection.setLocalDescription(offer);
        socket.send(JSON.stringify({ type:'offer', offer, to: partnerInfo.username, username, avatar:'' }));
      });
    }
  });
}

// æ¥å¬
function acceptCall(){
  const callStatus = document.getElementById('callStatus');
  callStatus.innerText = 'å·²æ¥å¬ï¼Œæ­£åœ¨å»ºç«‹é€šè¯...';
  document.querySelector('#callOverlay audio').pause();

  peerConnection.setRemoteDescription(new RTCSessionDescription(window.incomingOffer)).then(()=>{
    peerConnection.createAnswer().then(answer=>{
      peerConnection.setLocalDescription(answer);
      socket.send(JSON.stringify({ type:'answer', answer, to: partnerInfo.username }));
    });
  });
}

// æŒ‚æ–­
function endCall(isCaller=false){
  if(peerConnection) peerConnection.close();
  if(localStream){
    localStream.getTracks().forEach(track=>track.stop());
  }
  const overlay = document.getElementById('callOverlay');
  if(overlay) overlay.remove();
  isCalling = false;
}
</script>

</body>
</html>
